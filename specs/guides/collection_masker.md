# Collection Masker Script

**Objective**: This document explains the architecture and functionality of the `dma-collection-masker` script.

## 1. Core Concept

The `dma-collection-masker` is a Python script designed to anonymize sensitive information within the collected data archives. It replaces real names of schemas, hosts, databases, and other identifiers with fake, randomly generated values. This is useful when the collected data needs to be shared without exposing sensitive information.

## 2. Project-Specific Implementation

The script is located in `scripts/masker/dma-collection-masker`. Its main logic is in the `run_masker` function, which performs the following steps:

1.  **Finds collection archives**: It searches the specified input directory for collection files (`.zip` or `.gz`).
2.  **Extracts the archive**: It extracts the contents of the collection archive into a temporary directory.
3.  **Builds an identity map**: It iterates through a predefined set of rules (`DATA_MASK_CONFIG`). For each rule, it reads the specified CSV file and column, and builds a dictionary (`identity_map`) that maps each original value to a new, fake value generated by the `DMAFaker` class.
4.  **Applies the identity map**: It then re-reads each CSV file and replaces the original values with the fake values from the `identity_map`.
5.  **Packages the masked collection**: Finally, it creates a new, masked ZIP archive of the modified CSV files and also generates a `.key` file that contains the mapping between the original and masked values.

### Pattern

The script uses a **rule-based processing pattern**. The `DATA_MASK_CONFIG` list defines a set of rules that determine which files and columns to mask. The script iterates through these rules and applies them to the data.

### Code Example

Here is a snippet from the `dma-collection-masker` script that shows how a rule is defined:

```python
DATA_MASK_CONFIG = [
    DataMaskRule(
        mask_type=DataMaskTypes.SCHEMA_NAME,
        table_name="columntypes",
        column_position=2,
        missing_ok=True,
        fake_function=fake.user_name,
    ),
    # ... more rules
]
```

## 3. How to Use

The script is executed from the command line, specifying the path to the collection archives and the output path for the masked files. For detailed instructions, refer to the `docs/user_guide/shell_scripts/oracle/collection_masker.md` file.

## 4. Troubleshooting

-   **`ModuleNotFoundError: No module named 'packaging'`**: This script requires the `packaging` library. If you encounter this error, install it using `pip install packaging`.
-   **File not found errors**: Ensure that the collection archives are in the correct directory and that the script has the necessary permissions to read them.
-   **Incorrectly masked data**: If you find that some data is not being masked correctly, you may need to add or modify a rule in the `DATA_MASK_CONFIG` list in the script.
